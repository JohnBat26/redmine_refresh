<% interval = RedmineRefresh.refresh_interval_for(User.current, params[:refresh]) %>
<script type="text/javascript">
//<![CDATA[
  //ADAPTED FROM:
  //http://www.dynamicdrive.com/dynamicindex6/refresh.htm

  //configure refresh interval (in seconds)
  var countDownTime = <%= interval + 1 %>;
  var counter;

  function countDown() {
    countDownTime--;
    //BEWARE: PROTOTYPE!
    $('#refresher_seconds').html(countDownTime);
    //refresh
    if (countDownTime <= 0) {
      countDownTime = <%= interval %>
      clearTimeout(counter);
      window.location.reload();
    } else {
      counter = setTimeout("countDown()", 1000);
    }
  }

  function stopCountDown(url) {
    clearTimeout(counter);
    window.location.href = url
  }

  function startCountDown(url) {
    window.location.href = url
  }

  $(function() {
    if (window.location.search.indexOf("refresh=") >= 0) { countDown(); }
  })
//]]>
</script>

<% opts = {:class => 'icon icon-reload', :id => 'refresher'} %>
<% if params[:refresh].to_i >= 10 %>
  <%= link_to_function l(:refresh_in, content_tag(:span, interval, :id => 'refresher_seconds')).html_safe,
                       "startCountDown('#{url_for(params.except(:refresh))}')", opts %>
<% else %>
  <%= link_to_function l(:automatic_refresh), "stopCountDown('#{url_for(params.merge(:refresh => interval))}')", opts %>
<% end %>
